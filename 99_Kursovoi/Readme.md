# Курсовая работа по итогам модуля "DevOps и системное администрирование"


1. Для создания виртуальной машины используем Vagrant c образом Buento/21-10. Конфигурационный файл виртуальный машины приложил.
Выполнение курсовой решил максимально автоматизировать с использованием Vagrantfile.
2. В образе уже присутсвовал firewall UFW. Команда для его установки `sudo apt install ufw`
Разрешаем SSH и HTTPS трафик, разрешаем обращение с localhost. Политика для входящего трафика по-умолчанию DENY.  
`ufw allow 22; ufw allow 443; ufw allow from 127.0.0.1; ufw default deny; echo "y" | ufw enable;`  
3. Установка HashiCorp Vault согласно инструкции на сайте.
```commandline
curl -fsSL https://apt.releases.hashicorp.com/gpg | sudo apt-key add -
sudo apt-add-repository "deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"
sudo apt-get update && sudo apt-get install vault
```
Проверяем что все корректно установилось выполняем команду  `vault`
4. Создаем центр сертификации и выпускаем сертификат для NGINX.  
Для автоматизации первого запуска Vault и выпуска первых необходимых сертификатов написал скрипт vaultFirstTimeRun.sh расположен в папке conf.  
Разберем содержимое файла.  
В первую очередь объевляем переменную среды VAULT_ADDR для взаимодействия с хранилищем.  
Выполняем запуск хранилища в первый раз вручную, для продолжения выполнения команд Vault запускаем в screen.  
Выполняем инициализацию хранилища, заносим все выходные данные в файл(UNSEAL токены и ROOT токен) для дальнейшей обработки.  
Парсим получившийся файл и создаем два файла с переменными, в первом будут храниться ключи UNSEAL во втором ROOT токен.  
Объявляем пеменную среды VAULT_TOKEN для работы с хранилищем. И загружаем ключи UNSEAL из файла командой source.  
Выполняем скриптованное распечатование хранилища, и выполняем первоначальную настройку хранилища для выпуска сертификатов.  
Выпускаем корневой и промежуточный сертификат для установки на хостовую машину, для подтверждения достоверности сертификата сайта.  
Далее копируем сгенерированные сертификаты в примонтированную папку и дополнительно передаем служебную информацию о сервере.  
Финальным шагом скрипта первоначальной настройки, создаем задачу в cron для генерации нового сертификата сайта для NGINX каждые 10 минут каждого часа. (для тестирования)  
  
Разберем скрипт автоматической генерации сертификата сайта расположен в папке conf с названием vaultUpdateCertNginx.sh  
В первой части скрипта объявляем переменные среды для корректнйо работы с хранилищем. Далее распечатываем его.  
Для удобства обработки вывода команды создания сертификатов создадим перменную $json в которой будет хранится вывод команды.  
Для конроля корректности команды проверяем наличие содержимого в переменной $json.  
Если все в порядке то парсим переменную JSON через JQ и перемещаем сгенерированные сертификаты согласно конфигурации сайта NGINX.  
Выполняем перезапуск NGINX для применение новых сертификатов и запечатываем хранилище.  
Для контроля работы скрипта ключевые моменты выводятся(логируется) в файл startuplog.

5. Установить корневой и промежуточный сертификат в хостовую системы или в хостовой браузер. При выполения скрипта первоначальной настройки нужные сертификаты находятся в папке conf(CA_cert.crt и intermediate.crt)
6. Команда для установки NGINX `apt install nginx`
7. Файл конфигурации для сайта с поддержкой SSL сертификата на HTTPS и 443 порту. Должен быть создан по пути `/etc/nginx/sites-available/sslsite`  с содержимым:
```commandline
root@vagrant:/home/vagrant/vault# cat /etc/nginx/sites-available/sslsite 
server {
      listen 443 ssl;
      listen [::]:443 ssl;
      ssl_certificate /etc/ssl/certs/test.shadow.com.crt;
      ssl_certificate_key /etc/ssl/private/test.shadow.com.key;
      ssl_protocols TLSv1.2 TLSv1.1 TLSv1;
}
```
Соблюдаем пути расположение ключевого файла и файла сертификата, они должны совпадать с путями в скрипте генераторе сертификатов.  
Далее делаем ссылку на файл конфигурации для запуска его в работу.  
`ln -s /etc/nginx/sites-available/sslsite /etc/nginx/sites-enabled/`  
Перезапускаем NGINX. `systemctl restart nginx`  
В моем случае я копирую заранее подготовленный файл в папку с конфигурацией и делаю ссылку, через Vagrantfile.
8. Откройте в браузере на хосте https адрес страницы, которую обслуживает сервер nginx. 
Для корректной работы сайта и доступа к сайту по имени необходимо или воспользоваться DNS-сервером локальным или прописать сопоставление в файл hosts. Расположение файла зависит от используемой системы.
Открываем сайт до импорта корневого и промежуточного сертификата и видим ошибку доверия.  
![badsite!](/99_Kursovoi/images/badSite.png)<br>
Импортируем сертификаты  
![addCert!](/99_Kursovoi/images/addCAandInter.png)<br>
![checkCert!](/99_Kursovoi/images/addedCAandInter.png)<br>
Проверяем сайт повторно.  
![gsite!](/99_Kursovoi/images/goodSite.png)<br>
Проверяем что отработал скрипт обновления сертификата сайта. Время жизни сертификата изменилось.  
![rsite!](/99_Kursovoi/images/renewedCert.png)<br>
10. Создайте скрипт, который будет генерировать новый сертификат в vault:
Расположен в conf/vaultUpdateCertNginx.sh
11. Поместите скрипт в crontab, чтобы сертификат обновлялся какого-то числа каждого месяца в удобное для вас время.
Для добавления скрипта в crontab в скрипте первого запуска выполняются строки. 
```commandline
crontab -l > cron_bkp
echo "*/10 * * * * /bin/bash /vaultprod/vaultUpdateCertNginx.sh" >> cron_bkp
crontab cron_bkp
rm cron_bkp
```
Скрипт будет выполняется каждые 10 минут каждого часа. С учетом времени жизни сертификата логично установить его обновление каждое 1 и 29 число месяца, чтоб исключить проблему с 31 днем, т.к. время жизни сертификат 30 дней или 720 часов. Или продлить сертифкат еще на 48 часов и генерировать каждое 1 число месяца.
echo "1 0 1,29 * * /bin/bash /vaultprod/vaultUpdateCertNginx.sh" >> cron_bkp
  
Дополнительная информация.  
Vagrantfile  
Очень помогло монтирование папки. Научился как передавать подтверждение командаам например ufw enable.
Для оптимизации удобно логические блоки выносить в отдельные скрипты.
Файл запуска службы vault тоже заменил на свой, в процессе отладки там были и переменные среды и команды выполняем после запуска, но в итоге все ушло в скрипты.
  
По скриптам.  
Повторный export одной и тойже перменной избавляет от плавающей ошибки доступа к Vault.
Без sleep в скрипте работать с vault не возможно, постоянно сваливался в ошибку. Криптография требует процессорное время и как следствие паузы при выполнении команд скрипта.
Долго думал как упростить вытаскивание UNSEAL ключей и ROOT токена.
jq шикарная команда, никогда раньше ее не использовал и не слышал.
  
Для тестирования использовал сертификат для сайта на 24 часа и перевыпускал его каждые 10 минут.
Инфраструктура как код шикарный подход, но для новичка трудоемкий, написание и отладка автоматизации заняла около 20 часов.